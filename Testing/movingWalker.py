#!/usr/bin/env python

import glob
import os
import sys

try:
    sys.path.append(glob.glob('../carla/dist/carla-*%d.%d-%s.egg' % (
        sys.version_info.major,
        sys.version_info.minor,
        'win-amd64' if os.name == 'nt' else 'linux-x86_64'))[0])
except IndexError:
    pass
import carla
import time
import gym
import numpy as np

class MiniEnv(gym.Env):
    """Custom Environment that follows gym interface"""
    collision_sensor: object

    def __init__(self):
        super(MiniEnv, self).__init__()

        # === Carla ===
        self.host = 'localhost'
        self.town = 'Town01'

        self.client = carla.Client(self.host, 2000)
        self.client.set_timeout(60.0)
        self.world = self.client.get_world()
        self.blueprint_library = self.world.get_blueprint_library()
        self.actor_list = []

        # === set correct map ===
        self.map = self.world.get_map()
        if not self.map.name.endswith(self.town):
            self.world = self.client.load_world(self.town)
            while not self.world.get_map().name.endswith(self.town):
                time.sleep(0.2)
            self.world = self.client.get_world()
            self.map = self.world.get_map()

        # === set fixed time-step and synchronous mode
        settings = self.world.get_settings()
        settings.synchronous_mode = True  # Enables synchronous mode
        settings.fixed_delta_seconds = 0.05
        self.world.apply_settings(settings)
        self.client.reload_world(False)

        self.transform_walker_default = self.world.get_map().get_spawn_points()[35]

        # === walker ===
        self.max_walking_speed = 5   # 18/3,6 m/s
        self.walker = self.__spawn_walker()
        self.collision_sensor = None

        # === Draw Start/ End Point ===
        self._set_camara_view()

    def __spawn_walker(self):
        # === Load Blueprint and spawn walker ===
        self.walker_bp = self.blueprint_library.filter('0012')[0]
        walker = self.world.spawn_actor(
            self.walker_bp, self.transform_walker_default)
        self.actor_list.append(walker)
        try:
            self.collision_sensor = self.world.spawn_actor(
                self.blueprint_library.find('sensor.other.collision'),
                carla.Transform(), attach_to=walker)
        except:
            print("collision sensor failed")
        return walker

    def _set_camara_view(self):
        # === Walker View Camera ===
        spectator = self.world.get_spectator()
        location = self.transform_walker_default.location
        # location = carla.Location(x=143.119980, y=326.970001, z=0.300000)
        transform = carla.Transform(location, self.transform_walker_default.rotation)
        spectator.set_transform(carla.Transform(transform.location + carla.Location(z=20),
                                                carla.Rotation(pitch=-90)))

    def reset_walker(self):
        try:
            self.collision_sensor.destroy()
        except:
            print("Collion Sensor")
        self.walker.destroy()
        self.walker = self.__spawn_walker()
        self.world.tick()

    def step(self, action):
        # === Let the walker do a move ===
        # action = get_round_values(action, 1)
        action_length = np.linalg.norm(action)
        if action_length == 0.0:
            # the chances are slim, but theoretically both actions could be 0.0
            unit_action = np.array([0.0, 0.0], dtype=np.float32)
        elif action_length > 1.0:
            # create a vector for the action with the length of zero
            unit_action = action / action_length
        else:
            unit_action = action

        direction = carla.Vector3D(x=float(unit_action[0]), y=float(unit_action[1]), z=0.0)
        walker_control = carla.WalkerControl(
            direction, speed=self.max_walking_speed, jump=False)
        self.walker.apply_control(walker_control)
        # === Do a tick, an check if done ===
        self.world.tick()


if __name__ == '__main__':
    env = MiniEnv()
    actions = [[-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236], [-0.1891055405139923, -0.24553485214710236]]

    # Ground truth
    env.reset_walker()
    positions = []
    for index, action in enumerate(actions):
        positions.append(env.walker.get_transform().location)
        env.step(action=action)
    for epoch in range(100):
        sprint = True
        env.reset_walker()
        for index, action in enumerate(actions):
            if positions[index].x != env.walker.get_transform().location.x:
                if sprint:
                    print("Oh no:", index, env.walker.get_transform().location.x, "soll:", positions[index].x)
                    sprint = False
            env.step(action=action)

        if epoch%10==0:
            print(epoch)
